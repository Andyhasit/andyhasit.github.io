!function(){"use strict";const t=console;class e{constructor(t,e,s){this._app=t,this._props=e,this._key=s,this._vCache={},this._matchers={},this._vals={},this.v=this._view.bind(this)}draw(){this._draw(n,this.v,this._app,this._props,this._key,this)}wrap(t){return this.root=t,this.el=t.el,t}match(t,e){this._matchers.hasOwnProperty(t)||(this._matchers[t]=[]),this._matchers[t].push(e)}update(t){this._update(n,this.v,this._app,t,this._key,this)}_update(t,e,s,n,r,i){for(let t in i._matchers){let e=n[t];i._vals[t]!==e&&i._matchers[t].forEach(t=>{t(e,n)}),i._vals[t]=e}}_view(t,e,s){let n;if(null==s)(n=new t(this._app,e)).draw();else{let r=t.name;this._vCache.hasOwnProperty(r)||(this._vCache[r]={});let i=this._vCache[r];i.hasOwnProperty(s)?n=i[s]:((n=new t(this._app,e,s)).draw(),i[s]=n)}return n.update(e),n}}class s extends e{_draw(t,e,s,n,r,i){i.wrap(i.overlay(t,e,s,n,r,i).on("click",t=>{t.target==i.el&&i.reject("user-cancelled")})),i.promise=new Promise((t,e)=>{i.resolve=t,i.reject=e}),i.root.inner(i.content(t,e,s,n,r,i))}}function n(t){return new r(t)}class r{constructor(t){t.startsWith("#")?this.el=document.getElementById(t.substr(1)):this.el=document.createElement(t)}atts(t){for(let e in t)this.el.setAttribute(e,t[e]);return this}checked(t){return this.el.checked=t,this}class(t){return this.el.className=t,this}clear(){return this.el.innerHTML="",this}on(t,e){return this.el.addEventListener(t,e),this}id(t){return this.el.id=t,this}inner(t){this.el.innerHTML="",Array.isArray(t)||(t=[t]);let s=document.createDocumentFragment();return t.forEach(t=>{t instanceof r||t instanceof e?s.appendChild(t.el):t instanceof Node?s.appendChild(t):s.appendChild(document.createTextNode(t.toString()))}),this.el.appendChild(s),this}html(t){return this.el.innerHTML=t,this}text(t){return this.el.textContent=t,this}}class i extends e{constructor(t,e){super(t),this.wrap(n("#"+e))}goto(t){this.root.inner(this._view(t.cls,t.props,t.keyFn(t.props)))}}class a{constructor(t,e,s){let n;this.cls=e,this.keyFn=s||function(){return 1},[t,n]=t.split("?"),this.pattern=t,this.chunks=t.split("/").map(t=>t.startsWith("{")?new o(t.slice(1,-1)):t),this.params={},n&&n.split(",").forEach(t=>{let e=new o(t.trim());this.params[e.name]=e})}matches(t){let e,s,n;[e,s]=t.split("?"),n=e.split("/");let r,i,a={},h=0,c=this.chunks.length,l=!1;if(c==n.length){for(;;){if(r=this.chunks[h],i=n[h],r instanceof o)a[r.name]=r.convert(i);else if(r!==i){l=!0;break}if(++h>c)break}if(!l)return s&&s.split("&").forEach(t=>{let e,s;[e,s]=t.split("="),this.params.hasOwnProperty(e)&&(a[e]=this.params[e].convert(s))}),this.props=a,!0}return!1}}class o{constructor(t){let e,s;switch([e,s]=t.split(":"),this.name=e,s){case"int":this.conv=(t=>parseInt(t));break;case"float":this.conv=(t=>parseFloat(t));break;default:this.conv=(t=>t)}}convert(t){return this.conv(t)}}const h=console;class l{constructor(t={keyPath:"id",autoIncrement:!0}){this.defaultConf=t,this._versions=[]}addVersion(t){this._versions.push(t)}getVersion(){return this._versions.length+1}upgrade(t,e){let s=new d(this,t,this.defaultConf);this._versions.forEach((t,n)=>{n>=e&&t(s,!0)})}createFunctions(t){let e=new u(this,t);this._versions.forEach((t,s)=>{t(e,!1)})}getFkName(t){return`__${t}Id`}getLinkStoreName(t,e){return`m2m__${t}__${e}`}}class u{constructor(t,e){this.schema=t,this.target=e}capitalize(t){return t.charAt(0).toUpperCase()+t.slice(1)}addStore(t){let e=this.capitalize(t),s=e+"s";this.target["put"+e]=function(e){return this.put(t,e)},this.target["del"+e]=function(e){return this.del(t,e)},this.target["get"+e]=function(e){return this.get(t,e)},this.target["getAll"+s]=function(e){return this.getAll(t,e)}}oneToMany(t,e){let s=this.capitalize(t),n=this.capitalize(e),r=n+"s";this.target["get"+n+s]=function(s){return this.getParent(e,t,s)},this.target["get"+s+r]=function(s){return this.getChildren(t,e,s)},this.target["set"+n+s]=function(s,n){return this.setParent(e,t,s,n)}}manyToMany(t,e){this.target;let s=this.schema.getLinkStoreName(t,e),n=this.capitalize(t),r=this.capitalize(e),i=n+"s",a=r+"s";this.target["get"+n+a]=function(t){return this.getChildren(e,s,t)},this.target["get"+r+i]=function(t){},this.target["link"+n+r]=function(s,n){return this.link(t,e,s,n)},this.target["link"+r+n]=function(s,n){return this.link(t,e,n,s)},this.target["unlink"+n+r]=function(t,e){},this.target["unlink"+r+n]=function(t,e){}}}class d{constructor(t,e,s){this.schema=t,this.idb=e,this.stores={},this.defaultConf=s}addStore(t,e=this.defaultConf){let s=this.idb.createObjectStore(t,e);return this.stores[t]=s,s}oneToMany(t,e){h.log(t),h.log(e),h.log(this.schema.getFkName(t)),this.stores[e].createIndex(t,this.schema.getFkName(t))}manyToMany(t,e){let s=this.idb.createObjectStore(this.schema.getLinkStoreName(t,e),this.defaultConf);s.createIndex(t,this.schema.getFkName(t)),s.createIndex(e,this.schema.getFkName(e))}}const p=new l;var m;m="mop-todos",indexedDB.deleteDatabase(m),p.addVersion((t,e)=>{let s=t.addStore("day");t.addStore("task"),t.addStore("tag");t.oneToMany("day","task"),t.manyToMany("tag","task"),e&&s.put({day:"mon"})});const g=new class{constructor(t,e){if(e instanceof l)this.schema=e;else{let t=new l;t.addVersion(e),this.schema=t}this._caches={},this._fullyLoaded={},this._dbp=new Promise((e,s)=>{let n=indexedDB.open(t,this.schema.getVersion());n.onerror=(()=>{console.log(n.error),s(n.error)}),n.onsuccess=(()=>{this.schema.createFunctions(this),e(n.result)}),n.onupgradeneeded=(t=>{this.schema.upgrade(n.result,t.oldVersion)})})}ready(){return this._dbp}clear(){let t=[];return this._dbp.then(e=>{let s=e.objectStoreNames,n=e.objectStoreNames.length;for(let e=0;e<n;e++){let n=s[e];t.push(this._wrap(n,"clear","readwrite").then(()=>this._caches[n]={}))}return Promise.all(t)})}dump(){let t={},e=[];return this._dbp.then(s=>{let n=s.objectStoreNames,r=s.objectStoreNames.length;for(let s=0;s<r;s++){let r=n[s];e.push(this.getAll(r).then(e=>t[r]=e))}return Promise.all(e).then(e=>t)})}_cacheOf(t){return this._caches.hasOwnProperty(t)||(this._caches[t]={}),this._caches[t]}_wrap(t,e,s,...n){return this._dbp.then(r=>new Promise((i,a)=>{let o=r.transaction(t,s),h=o.objectStore(t)[e](...n);o.oncomplete=(()=>i(h.result)),o.onabort=o.onerror=(()=>a(o.error))}))}put(t,e){return this._wrap(t,"put","readwrite",e).then(s=>(e.id=s,this._cacheOf(t)[s]=e,e))}del(t,e){return this._wrap(t,"delete","readwrite",e.id).then(s=>(delete this._cacheOf(t)[e.id],!0))}get(t,e){let s=this._cacheOf(t)[e];return null==s?this._wrap(t,"get",void 0,e).then(s=>(this._cacheOf(t)[e]=s,s)):Promise.resolve(s)}getAll(t){return this._fullyLoaded[t]?Promise.resolve(Object.values(this._cacheOf(t))):this._wrap(t,"getAll").then(e=>{let s=this._cacheOf(t);return this._fullyLoaded[t]=!0,e.map(t=>s[t.id]=t),e})}_criteriaMatch(t,e){for(let s in e)if(t[s]!==e[s])return!1;return!0}_fetchOne(t,e){return this._dbp.then(s=>new Promise((n,r)=>{let i=[],a=s.transaction(t).objectStore(t).openCursor();a.onerror=(t=>h.log(t)),a.onsuccess=(t=>{var s=t.target.result;if(s){let t=s.value;this._criteriaMatch(t,e)?i.push(t):s.continue()}else n(i)})}))}filter(t,e){return this._dbp.then(s=>new Promise((n,r)=>{let i=[],a=s.transaction(t).objectStore(t).openCursor();a.onerror=(t=>r(a.error)),a.onsuccess=(t=>{var s=t.target.result;if(s){let t=s.value;this._criteriaMatch(t,e)&&i.push(t),s.continue()}else n(i)})}))}getParent(t,e,s){let n=s[this.schema.getFkName(e)];return null==n?Promise.resolve(void 0):this.get(e,n)}_filterOnIndex(t,e,s){return this._dbp.then(n=>new Promise((r,i)=>{let a=[],o=n.transaction(t);console.log(e);let h=o.objectStore(t).index(e),c=IDBKeyRange.only(s);h.openCursor(c).onsuccess=(t=>{let e=t.target.result;if(e){let t=e.value;a.push(t),e.continue()}else r(a)})}))}getChildren(t,e,s){return this._filterOnIndex(e,t,s.id)}getLinked(t,e,s){return this._dbp.then(n=>new Promise((r,i)=>{let a=[],o=n.transaction(t).objectStore(t).index(e),h=IDBKeyRange.only(s.id);o.openCursor(h).onsuccess=(t=>{let e=t.target.result;if(e){let t=e.value;a.push(t),e.continue()}else r(a)})}))}setParent(t,e,s,n){return s[this.schema.getFkName(e)]=n.id,this.put(t,s)}link(t,e,s,n){let r=this.schema.getLinkStoreName(t,e),i={};return i[this.schema.getFkName(t)]=s.id,i[this.schema.getFkName(e)]=n.id,this.put(r,i)}}("mop-todos",p);class _ extends s{overlay(t,e,s,n,r,i){return t("div").class("modal-background")}content(t,e,s,n,r,i){let a="",o=t("input").class("modal-autofocus").on("change",t=>{a=t.target.value});return o.el.focus(),t("div").class("modal-content modal-animate").inner([t("div").inner([o]),t("button").text("OK").on("click",t=>i.resolve({text:a})),t("button").text("Cancel").on("click",t=>i.reject("user-cancelled"))])}}const f=[["/",class extends e{_draw(t,e,s,n,r,i){i.tasksUL=t("ul"),i.btnAdd=t("button").text("Add").on("click",t=>{s.showModal(new _).then(t=>{s.addTask(t)})}),i.wrap(t("div").inner([i.btnAdd,i.tasksUL])),s.on("tasks-updated",e=>i.drawTasksUl(t,i,e)),c.log(994)}drawTasksUl(t,e,s){e.tasksUL.inner(s.map(e=>t("div").inner(e.text)))}}],["todos/{id}?name,age",""]],w=new class{constructor(){this._eventWatchers={},this._views={}}view(t,e){let s=new t(this);s.draw(),e&&(this._views[e]=s)}emit(t,e){this._watchers(t).forEach(t=>t(e))}on(t,e){this._watchers(t).push(e)}_watchers(t){let e=this._eventWatchers[t];return null==e&&(e=[],this._eventWatchers[t]=e),e}};w.db=g,w.router=new class{constructor(t,e,s){this._app=t,this.pageContainer=new i(this._app,e),this.routes=s.map(t=>new a(...t)),window.addEventListener("hashchange",t=>this._hashChanged()),window.addEventListener("load",t=>this._hashChanged())}add(t,e,s){this.routes.push(new a(t,e,keyFn))}_hashChanged(t){let e=location.hash.slice(1)||"/",s=this._getRoute(e);if(!s)throw new Error("Route not matched: "+e);this.pageContainer.goto(s)}_goto(t){}_getRoute(t){let e=this.routes.length;for(let s=0;s<e;s++){let e=this.routes[s];if(e.matches(t))return e}}}(w,"page-container",f),w.modalContainer=new class{constructor(t){this._el=n("#"+t)}showModal(e){e.draw(),this._el.inner(e);let s=document.getElementsByClassName("modal-autofocus")[0];return s&&s.focus(),e.promise.then(t=>(this._el.clear(),t)).catch(e=>{throw this._el.clear(),t.log(`Modal rejected (${e}). You can ignore the next error log.`),e})}}("modal-container"),w.view(class extends e{_draw(t,e,s,n,r,i){let a=t("span").html("&#9776;").class("menu-button").on("click",t=>i.showMenu()),o=t("a").atts({href:"#"}).html("&times;").class("closebtn").on("click",t=>i.hideMenu());i.menuDiv=t("div").id("menu").class("overlay").inner([o,t("div").class("overlay-content").inner([i.getMenuEntry(s,t,"Home",""),i.getMenuEntry(s,t,"Page2","page2"),i.downloadButton(t,e,s,n,r,i)])]),i.wrap(t("#menu-container")).inner([i.menuDiv,a])}downloadButton(t,e,s,n,r,i){return t("a").atts({href:"#"}).text("Download").on("click",t=>{s.db.dump().then(t=>{!function(t,e){var s=document.createElement("a");s.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),s.setAttribute("download",t),s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s)}("pointydb.json",JSON.stringify(t)),this.hideMenu()})})}getMenuEntry(t,e,s,n){return e("a").atts({href:"#"+n}).text(s).on("click",t=>{this.hideMenu()})}showMenu(){this.menuDiv.atts({style:"width: 70%"})}hideMenu(){this.menuDiv.atts({style:"width: 0"})}}),w.db.ready().then(()=>{w.refreshTasks(),console.log("ok")}),w.showModal=function(t){return w.modalContainer.showModal(t)},w.goto=function(t){},w.refreshTasks=function(){this.db.getAll("task").then(t=>this.emit("tasks-updated",t))},w.addTask=function(t){this.db.putTask(t).then(t=>{this.refreshTasks()})}}();